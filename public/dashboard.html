<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpotAlert Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .elite-section {
      margin-top: 40px;
      background: #ffffffcc;
      border-radius: 14px;
      padding: 25px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .elite-section h3 { color: #003366; margin-bottom: 12px; }
    .replay-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .replay-stage { display: flex; justify-content: center; align-items: center; background: #0b1f33; border-radius: 10px; height: 360px; margin-bottom: 8px; overflow: hidden;}
    #replayFrame { max-width: 100%; max-height: 100%; object-fit: contain; }
    #replaySlider { width: 100%; }
    .replay-meta { display: flex; justify-content: space-between; font-size: 0.9rem; color: #334; }
    .download-btn { background: #0078ff; color: #fff; padding: 10px 20px; border-radius: 8px; margin-top: 10px; border: none; cursor: pointer; }
  </style>
</head>

<body>
  <header class="frosted-header">
    <img src="spotalert_logo.png" class="logo" />
    <nav>
      <a href="/">Home</a>
      <a href="/dashboard">Dashboard</a>
      <a href="#alerts">Alerts</a>
    </nav>
  </header>

  <div class="dashboard-container">
    <h2>ðŸ“· SpotAlert CCTV Dashboard</h2>
    <div id="currentPlan">Current Plan: <strong>Free Trial (14 Days)</strong></div>

    <form id="faceUploadForm" enctype="multipart/form-data">
      <input type="file" name="image" accept="image/*" required />
      <button type="submit">Upload & Analyze</button>
    </form>

    <div class="alert-panel">
      <h3>Recent Alerts</h3>
      <ul id="alertList"></ul>
    </div>

    <div class="action-buttons">
      <button id="upgradeBtn">Upgrade Plan</button>
      <button id="logoutBtn" onclick="window.location='/'">Logout</button>
    </div>

    <section class="elite-section">
      <h3>ðŸŽž Incident Replay Timeline (Elite Only)</h3>

      <div class="replay-controls">
        <label>Window:
          <select id="replayWindow">
            <option value="5">Last 5 min</option>
            <option value="10" selected>Last 10 min</option>
            <option value="30">Last 30 min</option>
            <option value="60">Last 60 min</option>
          </select>
        </label>

        <button id="replayLoad">Load</button>
        <button id="replayPlay">Play</button>
        <button id="replayPause" disabled>Pause</button>

        <label>Speed:
          <select id="replaySpeed">
            <option value="1">1x</option>
            <option value="2" selected>2x</option>
            <option value="4">4x</option>
          </select>
        </label>
      </div>

      <div class="replay-stage">
        <img id="replayFrame" />
      </div>

      <input id="replaySlider" type="range" min="0" max="0" value="0" />

      <div class="replay-meta">
        <span id="replayIndex">0 / 0</span>
        <span id="replayTs">â€”</span>
      </div>

      <button class="download-btn" id="downloadIncidentPDF">ðŸ“„ Download Incident Report (PDF)</button>
    </section>
  </div>

  <div id="shira-assistant" title="Chat with Shira">ðŸ’¬</div>

  <script>
    /* === FINAL BACKEND URL â€” DO NOT CHANGE === */
    const API_BASE = "http://54.159.59.142:3000";

    const form = document.getElementById("faceUploadForm");
    const list = document.getElementById("alertList");

    /* === FACE UPLOAD === */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const res = await fetch(`${API_BASE}/trigger-alert`, { method: "POST", body: data });
      const json = await res.json();

      const li = document.createElement("li");
      li.textContent = json.faces?.length
        ? `âœ… Known face detected (${json.faces.length})`
        : "ðŸš¨ Unknown face detected â€” alert sent!";
      list.prepend(li);
    });

    /* === SHIRA ASSISTANT === */
    const shira = document.getElementById("shira-assistant");
    shira.addEventListener("click", async () => {
      const msg = prompt("Ask Shira about SpotAlert:");
      if (!msg) return;
      const res = await fetch(`${API_BASE}/shira`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      alert(data.reply);
    });

    /* === LOAD INCIDENT REPLAY === */
    document.getElementById("replayLoad").addEventListener("click", async () => {
      const mins = document.getElementById("replayWindow").value;
      const res = await fetch(`${API_BASE}/api/elite/replay?minutes=${mins}`);
      const frames = await res.json();

      window.replayFrames = frames;
      window.replayIndex = 0;

      document.getElementById("replaySlider").max = frames.length - 1;
      updateReplayFrame();
    });

    /* === SHOW FRAME === */
    async function updateReplayFrame() {
      const frames = window.replayFrames || [];
      if (!frames.length) return;

      const current = frames[window.replayIndex];
      document.getElementById("replayIndex").textContent =
        `${window.replayIndex + 1} / ${frames.length}`;
      document.getElementById("replayTs").textContent = current.timestamp;

      const signed = await fetch(`${API_BASE}/api/elite/frame-url?key=${current.image}`);
      const json = await signed.json();

      document.getElementById("replayFrame").src = json.url;
      document.getElementById("replaySlider").value = window.replayIndex;
    }

    /* === PLAYBACK === */
    document.getElementById("replayPlay").addEventListener("click", () => {
      if (!window.replayFrames?.length) return;
      document.getElementById("replayPause").disabled = false;

      window.replayTimer = setInterval(() => {
        window.replayIndex++;
        if (window.replayIndex >= window.replayFrames.length) window.replayIndex = 0;
        updateReplayFrame();
      }, 1000 / document.getElementById("replaySpeed").value);
    });

    /* === PAUSE === */
    document.getElementById("replayPause").addEventListener("click", () => {
      clearInterval(window.replayTimer);
      document.getElementById("replayPause").disabled = true;
    });

    /* === SLIDER DRAG === */
    document.getElementById("replaySlider").addEventListener("input", (e) => {
      window.replayIndex = Number(e.target.value);
      updateReplayFrame();
    });

    /* === DOWNLOAD INCIDENT PDF === */
    document.getElementById("downloadIncidentPDF").addEventListener("click", () => {
      window.location = `${API_BASE}/api/elite/incident-pdf`;
    });
  </script>

</body>
</html>
